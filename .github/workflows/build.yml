name: Build and Test

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly run every Sunday at midnight UTC

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  PYTHON_VERSION_DEFAULT: '3.12'
  CACHE_VERSION: v1

jobs:
  lint:
    name: Code Quality & Style Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis

    - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
        cache: 'pip'
        cache-dependency-path: requirements.txt

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install flake8 black isort pylint mypy

    - name: Code formatting check (Black)
      run: |
        black --check --diff . || {
          echo "âŒ Code formatting issues detected"
          echo "ðŸ’¡ Fix with: black ."
          exit 1
        }

    - name: Import sorting check (isort)
      run: |
        isort --check-only --diff . || {
          echo "âŒ Import sorting issues detected"
          echo "ðŸ’¡ Fix with: isort ."
          exit 1
        }

    - name: Lint with Flake8 (Critical errors)
      run: |
        # Stop on critical errors
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: Lint with Flake8 (Style guide)
      run: |
        # Check style but don't fail the build
        flake8 . --count --max-complexity=10 --max-line-length=127 \
          --statistics --exit-zero

    - name: Lint with Pylint
      run: |
        pylint downloader.py plugins/ tests/ --exit-zero \
          --output-format=colorized \
          --reports=y
      continue-on-error: true

    - name: Type checking with mypy
      run: |
        mypy downloader.py plugins/ --ignore-missing-imports --no-strict-optional
      continue-on-error: true

  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
        cache: 'pip'
        cache-dependency-path: requirements.txt

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install security tools
      run: pip install bandit safety pip-audit

    - name: Run Bandit security scanner
      run: |
        echo "ðŸ”’ Running Bandit security analysis..."
        bandit -r . -f json -o bandit-report.json --exit-zero
        bandit -r . -f screen
      continue-on-error: true

    - name: Check dependencies with Safety
      run: |
        echo "ðŸ” Checking dependencies for known vulnerabilities..."
        safety check --json || echo "âš ï¸ Vulnerabilities detected"
      continue-on-error: true

    - name: Audit dependencies with pip-audit
      run: |
        echo "ðŸ”Ž Auditing Python packages..."
        pip-audit --desc --format json || echo "âš ï¸ Issues found"
      continue-on-error: true

    - name: Upload security reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
        retention-days: 30

  build:
    name: Test on ${{ matrix.os }} with Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        exclude:
          # Optimize CI time by skipping some combinations
          - os: windows-latest
            python-version: '3.8'
          - os: windows-latest
            python-version: '3.9'
          - os: macos-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.9'
    
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
      FORCE_COLOR: 1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          pyproject.toml

    - name: Display Python version
      run: python -c "import sys; print(f'Python {sys.version}')"

    - name: Upgrade pip and install build tools
      shell: bash
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip --version

    - name: Install project dependencies
      shell: bash
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        pip install -r requirements.txt
        pip list

    - name: Install test dependencies
      shell: bash
      run: |
        echo "ðŸ§ª Installing test dependencies..."
        pip install pytest pytest-cov pytest-xdist pytest-timeout pytest-mock

    - name: Run test suite
      shell: bash
      run: |
        echo "ðŸ§ª Running tests with coverage..."
        pytest tests/ -v \
          --cov=. \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          -n auto \
          --timeout=300 \
          --tb=short
      timeout-minutes: 10
      env:
        COVERAGE_CORE: sysmon

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-${{ matrix.os }}-py${{ matrix.python-version }}
        fail_ci_if_error: false
        verbose: true
      continue-on-error: true

    - name: Compile Python files
      shell: bash
      run: |
        echo "âš™ï¸ Compiling Python files..."
        python -m py_compile downloader.py
        python -m compileall plugins/ -q
        python -m compileall tests/ -q
        echo "âœ… Compilation successful"

    - name: Verify imports
      shell: bash
      run: |
        echo "ðŸ” Verifying imports..."
        python -c "import downloader; print('âœ“ downloader imported')"
        python -c "from plugins import get_global_registry; print('âœ“ plugins imported')"
        echo "âœ… All imports successful"

    - name: Test CLI interface
      shell: bash
      run: |
        echo "ðŸ–¥ï¸ Testing CLI..."
        python downloader.py --help
        python downloader.py --version
        python downloader.py --show-config
        python downloader.py --list-plugins
        echo "âœ… CLI tests passed"

    - name: Test GUI module imports
      shell: bash
      run: |
        echo "ðŸŽ¨ Testing GUI module..."
        python -c "import ytdownloader_gui; print('âœ“ GUI module imports successfully')"
        echo "âœ… GUI module test passed"
      continue-on-error: true  # tkinter may not be available in all CI environments

    - name: Archive test artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts-${{ matrix.os }}-py${{ matrix.python-version }}
        path: |
          htmlcov/
          .coverage
          coverage.xml
          *.log
        retention-days: 14

  build-package:
    name: Build Distribution Packages
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for version detection

    - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
        cache: 'pip'

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine check-wheel-contents

    - name: Build source and wheel distributions
      run: |
        echo "ðŸ—ï¸ Building distributions..."
        python -m build
        ls -lh dist/

    - name: Check distribution packages
      run: |
        echo "ðŸ” Checking distributions..."
        twine check dist/*
        check-wheel-contents dist/*.whl

    - name: Display package info
      run: |
        echo "ðŸ“¦ Package information:"
        python -m tarfile -l dist/*.tar.gz | head -20
        python -m zipfile -l dist/*.whl | head -20

    - name: Upload distribution artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
        retention-days: 30
        if-no-files-found: error

  test-gui:
    name: Test GUI Components on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: [build]
    timeout-minutes: 10
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
        cache: 'pip'

    - name: Install dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install tkinter (Ubuntu only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk

    - name: Test GUI module import
      shell: bash
      run: |
        echo "ðŸŽ¨ Testing GUI module import..."
        python -c "import ytdownloader_gui; print('âœ“ GUI module loaded')" || echo "âš ï¸ GUI module import failed (tkinter may not be available)"
      continue-on-error: true

    - name: Test GUI help/version
      shell: bash
      run: |
        echo "ðŸ“ Testing GUI help..."
        python ytdownloader_gui.py --help || echo "âš ï¸ GUI help not available"
      continue-on-error: true

    - name: Validate GUI file structure
      shell: bash
      run: |
        echo "ðŸ” Validating GUI components..."
        test -f ytdownloader_gui.py || (echo "âŒ ytdownloader_gui.py not found" && exit 1)
        grep -q "class App" ytdownloader_gui.py || (echo "âŒ App class not found" && exit 1)
        grep -q "def main" ytdownloader_gui.py || (echo "âŒ main function not found" && exit 1)
        echo "âœ… GUI structure validated"

  test-install:
    name: Test Package Installation
    runs-on: ${{ matrix.os }}
    needs: [build-package]
    timeout-minutes: 10
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: Checkout code (for verification)
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

    - name: Download distribution artifacts
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    - name: Display downloaded files
      shell: bash
      run: ls -lh dist/

    - name: Install from wheel
      shell: bash
      run: |
        echo "ðŸ“¦ Installing from wheel..."
        pip install --upgrade pip
        pip install dist/*.whl
        pip list

    - name: Test installed CLI commands
      shell: bash
      run: |
        echo "ðŸ§ª Testing ytdownloader command..."
        ytdownloader --help
        ytdownloader --version
        
        echo "ðŸ§ª Testing ytdl alias..."
        ytdl --help
        ytdl --version
        
        echo "ðŸ§ª Testing GUI command..."
        ytdownloader-gui --help || echo "GUI requires tkinter (optional)"
        
        echo "âœ… All CLI commands working"

    - name: Test package imports
      shell: bash
      run: |
        echo "ðŸ” Testing Python imports..."
        python -c "import downloader; print('âœ“ downloader module')"
        python -c "from plugins import get_global_registry; print('âœ“ plugins module')"
        python -c "import downloader; print(f'Version: {downloader.__version__}')"
        echo "âœ… Package installation verified"

  status-check:
    name: âœ… All Tests Passed
    if: always()
    needs: [lint, security, build, test-gui, build-package, test-install]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Check all job statuses
      run: |
        echo "================================================"
        echo "           CI/CD Pipeline Status Report         "
        echo "================================================"
        echo ""
        echo "ðŸ“‹ Job Results:"
        echo "  Lint:          ${{ needs.lint.result }}"
        echo "  Security:      ${{ needs.security.result }}"
        echo "  Build:         ${{ needs.build.result }}"
        echo "  GUI Tests:     ${{ needs.test-gui.result }}"
        echo "  Build Package: ${{ needs.build-package.result }}"
        echo "  Test Install:  ${{ needs.test-install.result }}"
        echo ""
        echo "================================================"
        
        # Check required jobs
        if [ "${{ needs.build.result }}" != "success" ] || \
           [ "${{ needs.build-package.result }}" != "success" ] || \
           [ "${{ needs.test-install.result }}" != "success" ]; then
          echo "âŒ FAILED: One or more required jobs failed"
          echo ""
          echo "Please check the logs above for details."
          exit 1
        fi
        
        # Warn on optional job failures
        if [ "${{ needs.lint.result }}" == "failure" ]; then
          echo "âš ï¸  WARNING: Linting issues detected"
          echo "    Run 'make format' to auto-fix style issues"
        fi
        
        if [ "${{ needs.security.result }}" == "failure" ]; then
          echo "âš ï¸  WARNING: Security scan detected potential issues"
          echo "    Review security reports for details"
        fi
        
        echo ""
        echo "================================================"
        echo "âœ… SUCCESS: All required jobs passed!"
        echo "================================================"

    - name: Summary
      run: |
        echo "### ðŸŽ‰ CI/CD Pipeline Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| GUI Tests | ${{ needs.test-gui.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Package | ${{ needs.build-package.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Install | ${{ needs.test-install.result }} |" >> $GITHUB_STEP_SUMMARY

